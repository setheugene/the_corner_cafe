"use strict";var WPFormsEntriesExport=window.WPFormsEntriesExport||function(e,t,s){var r={$form:s("#wpforms-tools-entries-export"),$selectForm:s("#wpforms-tools-entries-export-selectform"),$selectFormSpinner:s("#wpforms-tools-entries-export-selectform-spinner"),$selectFormMsg:s("#wpforms-tools-entries-export-selectform-msg"),$expOptions:s("#wpforms-tools-entries-export-options"),$fieldsCheckboxes:s("#wpforms-tools-entries-export-options-fields-checkboxes"),$dateSection:s("#wpforms-tools-entries-export-options-date"),$dateFlatpickr:s("#wpforms-tools-entries-export-options-date-flatpickr"),$searchSection:s("#wpforms-tools-entries-export-options-search"),$searchField:s("#wpforms-tools-entries-export-options-search-field"),$submitButton:s("#wpforms-tools-entries-export-submit"),$cancelButton:s("#wpforms-tools-entries-export-cancel"),$processMsg:s("#wpforms-tools-entries-export-process-msg")},a=wpforms_tools_entries_export.i18n,n={},i={formsCache:{},init:function(){s(e).ready(i.ready)},ready:function(){n.processing=!1,i.initDateRange(),i.initFormCont(),i.initSubmit(),i.events()},events:function(){r.$selectForm[0].addEventListener("choice",function(e){e.detail.choice.placeholder?r.$expOptions.addClass("hidden"):n.formID!==e.detail.choice.value&&(n.formID=e.detail.choice.value,void 0===i.formsCache[n.formID]?i.retrieveFormAndRenderFields():i.renderFields(i.formsCache[n.formID]))}),s(e).on("csv_file_error",function(e,o){i.displaySubmitMsg(o,"error")})},retrieveFormAndRenderFields:function(){n.ajaxData={action:"wpforms_tools_entries_export_form_data",nonce:wpforms_tools_entries_export.nonce,form:n.formID},r.$selectFormSpinner.removeClass("hidden"),i.displayFormsMsg(""),s.get(ajaxurl,n.ajaxData).done(function(e){e.success?(i.renderFields(e.data.fields),i.formsCache[n.formID]=e.data.fields,r.$expOptions.removeClass("hidden")):(i.displayFormsMsg(e.data.error),r.$expOptions.addClass("hidden"))}).fail(function(e,o,s){i.displayFormsMsg(a.error_prefix+":<br>"+s),r.$expOptions.addClass("hidden")}).always(function(){r.$selectFormSpinner.addClass("hidden")})},exportAjaxStep:function(e){var o;n.processing&&(o=i.getAjaxPostData(e),s.post(ajaxurl,o).done(function(e){var o="";return clearTimeout(n.timerId),e.success?0===e.data.count?(i.displaySubmitMsg(a.prc_2_no_entries),void i.displaySubmitSpinner(!1)):"stop"===e.data.step?(o=a.prc_3_done,o+="<br>"+a.prc_3_download+', <a href="#" class="wpforms-download-link">'+a.prc_3_click_here+"</a>.",i.displaySubmitMsg(o,"info"),i.displaySubmitSpinner(!1),i.triggerDownload(e.data.request_id),void(n.processing=!0)):(o=a.prc_2_total_entries.replace("{total_entries}",e.data.count),o+="<br>"+a.prc_2_progress.replace("{progress}",Math.ceil(100*(e.data.step-1)/e.data.total_steps)),i.displaySubmitMsg(o,"info"),void i.exportAjaxStep(e.data.request_id)):(i.displaySubmitMsg(e.data.error,"error"),void i.displaySubmitSpinner(!1))}).fail(function(e,o,s){clearTimeout(n.timerId),i.displaySubmitMsg(a.error_prefix+":<br>"+s,"error"),i.displaySubmitSpinner(!1)}))},getAjaxPostData:function(e){var o;return"first-step"===e?(o=r.$form.serializeArray().reduce(function(e,o){return e[o.name]=o.value,e},{}),r.$fieldsCheckboxes.find("input").length<1&&(o.date="",o["search[term]"]="")):o={action:"wpforms_tools_entries_export_step",nonce:wpforms_tools_entries_export.nonce,request_id:e},o},initSubmit:function(){r.$submitButton.on("click",function(e){e.preventDefault(),s(this).hasClass("wpforms-btn-spinner-on")||(r.$submitButton.blur(),i.displaySubmitSpinner(!0),i.displaySubmitMsg(""),n.timerId=setTimeout(function(){i.displaySubmitMsg(a.prc_1_filtering+"<br>"+a.prc_1_please_wait,"info")},3e3),i.exportAjaxStep("first-step"))}),r.$cancelButton.on("click",function(e){e.preventDefault(),r.$cancelButton.blur(),i.displaySubmitMsg(""),i.displaySubmitSpinner(!1)})},initFormCont:function(){0<wpforms_tools_entries_export.form_id&&(r.$expOptions.removeClass("hidden"),r.$fieldsCheckboxes.find("input").length<1&&(r.$dateSection.addClass("hidden"),r.$searchSection.addClass("hidden")))},initDateRange:function(){var e=wpforms_tools_entries_export.lang_code,o=t.flatpickr,s={rangeSeparator:" - "};"undefined"!==o&&o.hasOwnProperty("l10ns")&&o.l10ns.hasOwnProperty(e)&&((s=o.l10ns[e]).rangeSeparator=" - "),r.$dateFlatpickr.flatpickr({altInput:!0,altFormat:"M j, Y",dateFormat:"Y-m-d",locale:s,mode:"range",defaultDate:wpforms_tools_entries_export.dates})},renderFields:function(n){if("object"==typeof n){var i={checkboxes:"",options:""},e=Object.keys(n);0===e.length?(i.checkboxes="<span>"+a.error_form_empty+"</span>",r.$dateSection.addClass("hidden"),r.$searchSection.addClass("hidden")):(e.forEach(function(e,o){var s='<label><input type="checkbox" name="fields[{i}]" value="{id}" checked> {label}</label>',t=parseInt(n[e].id,10);s=(s=(s=s.replace("{i}",parseInt(o,10))).replace("{id}",t)).replace("{label}",n[e].label),i.checkboxes+=s;var r='<option value="{id}">{label}</option>';r=(r=r.replace("{id}",t)).replace("{label}",n[e].label),i.options+=r}),r.$dateSection.removeClass("hidden"),r.$searchSection.removeClass("hidden")),r.$fieldsCheckboxes.html(i.checkboxes),r.$searchField.find("option:not(:first-child)").remove(),r.$searchField.append(i.options)}},displaySubmitSpinner:function(e){e?(r.$submitButton.addClass("wpforms-btn-spinner-on"),r.$cancelButton.removeClass("hidden"),n.processing=!0):(r.$submitButton.removeClass("wpforms-btn-spinner-on"),r.$cancelButton.addClass("hidden"),n.processing=!1)},displayFormsMsg:function(e){r.$selectFormMsg.html(e),0<e.length?r.$selectFormMsg.removeClass("hidden"):r.$selectFormMsg.addClass("hidden")},displaySubmitMsg:function(e,o){n.processing&&(o&&"error"===o?r.$processMsg.addClass("wpforms-error"):r.$processMsg.removeClass("wpforms-error"),r.$processMsg.html(e),0<e.length?r.$processMsg.removeClass("hidden"):r.$processMsg.addClass("hidden"))},triggerDownload:function(e){var o=wpforms_tools_entries_export.export_page;o+="&action=wpforms_tools_entries_export_download",o+="&nonce="+wpforms_tools_entries_export.nonce,o+="&request_id="+e,r.$expOptions.find("iframe").remove(),r.$expOptions.append('<iframe src="'+o+'"></iframe>'),r.$processMsg.find(".wpforms-download-link").attr("href",o)}};return i}(document,window,jQuery);WPFormsEntriesExport.init();